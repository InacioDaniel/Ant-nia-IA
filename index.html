<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenia-Antónia IA - by Angola Edition Mandjonbué</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background: #010409; color: #e6edf3; font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; margin: 0; }
        .chat-container { height: calc(100vh - 180px); overflow-y: auto; scroll-behavior: smooth; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .glass { background: rgba(13, 17, 23, 0.9); backdrop-filter: blur(12px); border: 1px solid #30363d; }
        
        .msg-wrapper { display: flex; flex-direction: column; gap: 5px; position: relative; max-width: 85%; }
        .user-wrapper { align-self: flex-end; }
        .ai-wrapper { align-self: flex-start; }

        .msg { padding: 16px; border-radius: 18px; line-height: 1.6; animation: fadeIn 0.2s ease; position: relative; width: 100%; }
        .user-msg { background: #1f6feb; border-bottom-right-radius: 2px; color: white; }
        .ai-msg { background: #161b22; border-bottom-left-radius: 2px; border: 1px solid #30363d; }
        
        /* Controles de Mensagem */
        .msg-tools { display: flex; gap: 10px; opacity: 0; transition: 0.2s; padding: 0 5px; }
        .msg-wrapper:hover .msg-tools { opacity: 1; }
        .tool-btn { font-size: 11px; cursor: pointer; color: #8b949e; background: none; border: none; font-weight: bold; }
        .tool-btn:hover { color: #58a6ff; }
        .tool-btn.del:hover { color: #f85149; }

        /* Blocos de Código */
        .code-wrapper { background: #0d1117; border-radius: 10px; border: 1px solid #444c56; margin: 10px 0; overflow: hidden; font-family: 'Fira Code', monospace; }
        .code-header { background: #161b22; padding: 8px 12px; display: flex; justify-content: space-between; border-bottom: 1px solid #30363d; font-size: 11px; }
        pre { padding: 15px; overflow-x: auto; font-size: 13px; color: #79c0ff; }

        /* Fullscreen Overlay */
        #previewOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; }
        #closePreview { position: fixed; top: 15px; right: 15px; background: #f85149; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; z-index: 10000; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; } }
        .typing { display: flex; gap: 4px; padding: 10px; }
        .typing div { width: 6px; height: 6px; background: #58a6ff; border-radius: 50%; animation: bounce 1.4s infinite; }
        @keyframes bounce { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(0.6); opacity: 0.4; } }
    </style>
</head>
<body>

    <div id="previewOverlay">
        <button id="closePreview" onclick="closeFullscreen()">FECHAR</button>
        <iframe id="previewFrame" style="width:100%; height:100%; border:none;"></iframe>
    </div>

    <div class="max-w-5xl mx-auto w-full h-full flex flex-col p-4">
        <header class="flex justify-between items-center mb-4 px-2">
            <div>
                <h1 class="text-2xl font-black text-white italic">ZENIA-ANTÓNIA</h1>
                <p class="text-[10px] text-blue-500 font-bold uppercase tracking-widest">By inácio.u.daniel | Edição Angola 2026</p>
            </div>
        </header>

        <div id="chatBox" class="chat-container">
            <div class="msg-wrapper ai-wrapper">
                <div class="msg ai-msg">
                    Olá! Sou a <b>Zenia-Antónia</b>. Fui atualizada por <b>inácio.u.daniel</b> para corrigir bugs de dados e JSON. Como posso ajudar Angola hoje?
                </div>
            </div>
        </div>

        <div class="mt-auto p-2">
            <div class="glass rounded-2xl flex items-center p-2 border-[#30363d] focus-within:border-[#58a6ff] transition-all">
                <input type="text" id="userInput" placeholder="Digite sua mensagem..." autocomplete="off" class="flex-1 bg-transparent border-none outline-none text-sm p-2 text-white">
                <button onclick="sendMessage()" id="sendBtn" class="bg-[#238636] hover:bg-[#2ea043] text-white px-6 py-2 rounded-xl font-bold transition shadow-lg">
                    Enviar
                </button>
            </div>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const overlay = document.getElementById('previewOverlay');
        const iframe = document.getElementById('previewFrame');

        // FUNÇÃO PARA LIMPAR JSON E BUG DE REASONING
        function cleanAIOutput(rawText) {
            let text = rawText;
            
            // Se a IA mandar o JSON bruto, extraímos apenas o conteúdo
            try {
                if (text.trim().startsWith('{')) {
                    const data = JSON.parse(text);
                    text = data.content || data.message || (data.choices && data.choices[0].message.content) || text;
                }
            } catch (e) {
                // Se falhar o parse, removemos as marcas de reasoning manualmente via Regex
                text = text.replace(/\{"role":.*?"content":"/g, '')
                           .replace(/"reasoning_content":".*?"/g, '')
                           .replace(/\\n/g, '\n')
                           .replace(/\\"/g, '"')
                           .replace(/\}$/g, '');
            }

            // Remove propagandas e ajusta nome
            return text.replace(/Support Pollinations\.AI.*/gs, '')
                       .replace(/Powered by Pollinations.*/gi, '')
                       .replace(/Antínia/gi, 'Zenia-Antónia')
                       .replace(/#/g, '')
                       .trim();
        }

        function formatDisplay(text) {
            let formatted = cleanAIOutput(text);
            
            // Blocos de Código
            const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
            formatted = formatted.replace(codeBlockRegex, (match, lang, code) => {
                const escapedCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                const previewBtn = (code.includes('<html') || code.includes('<!DOCTYPE')) ? 
                    `<button class="tool-btn" onclick="openFullscreen(this)">TELA CHEIA</button>` : '';
                
                return `<div class="code-wrapper">
                    <div class="code-header"><span>${lang || 'code'}</span>
                        <div class="flex gap-2">${previewBtn}<button class="tool-btn" onclick="copyCode(this)">COPIAR</button></div>
                    </div>
                    <pre><code>${escapedCode}</code></pre>
                </div>`;
            });

            return formatted.replace(/\*\*(.*?)\*\*/g, '<b class="text-blue-400">$1</b>').replace(/\n/g, '<br>');
        }

        function addMessage(content, isUser = false) {
            const wrapper = document.createElement('div');
            wrapper.className = `msg-wrapper ${isUser ? 'user-wrapper' : 'ai-wrapper'}`;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${isUser ? 'user-msg' : 'ai-msg'}`;
            msgDiv.innerHTML = isUser ? content : formatDisplay(content);

            const tools = document.createElement('div');
            tools.className = 'msg-tools';
            
            if(isUser) {
                tools.innerHTML = `
                    <button class="tool-btn" onclick="editMsg(this)">EDITAR</button>
                    <button class="tool-btn del" onclick="this.closest('.msg-wrapper').remove()">APAGAR</button>
                `;
            } else {
                tools.innerHTML = `
                    <button class="tool-btn" onclick="retryMsg(this)">REENVIAR</button>
                    <button class="tool-btn del" onclick="this.closest('.msg-wrapper').remove()">APAGAR</button>
                `;
            }

            wrapper.appendChild(msgDiv);
            wrapper.appendChild(tools);
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage(customText = null) {
            const text = customText || userInput.value.trim();
            if (!text) return;

            if(!customText) addMessage(text, true);
            userInput.value = '';

            const thinking = document.createElement('div');
            thinking.className = 'msg-wrapper ai-wrapper';
            thinking.innerHTML = '<div class="msg ai-msg"><div class="typing"><div></div><div></div><div></div></div></div>';
            chatBox.appendChild(thinking);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const sys = `Nome: Zenia-Antónia. Criador: inácio.u.daniel. Local: Angola. Ano: 2026. Responda apenas o texto final, sem metadados JSON.`;
                const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(sys + "\n" + text)}?model=openai&seed=${Math.random()}`);
                const result = await response.text();
                thinking.remove();
                addMessage(result);
            } catch (e) {
                thinking.innerHTML = "Erro de conexão.";
            }
        }

        // Funções de Edição e Reenvio
        function editMsg(btn) {
            const wrapper = btn.closest('.msg-wrapper');
            const oldText = wrapper.querySelector('.msg').innerText;
            const newText = prompt("Editar mensagem:", oldText);
            if(newText && newText !== oldText) {
                wrapper.remove();
                sendMessage(newText);
            }
        }

        function retryMsg(btn) {
            const wrapper = btn.closest('.msg-wrapper');
            const prevUserMsg = wrapper.previousElementSibling;
            if(prevUserMsg && prevUserMsg.classList.contains('user-wrapper')) {
                const text = prevUserMsg.querySelector('.msg').innerText;
                wrapper.remove();
                sendMessage(text);
            }
        }

        function copyCode(btn) {
            const code = btn.closest('.code-wrapper').querySelector('code').innerText;
            navigator.clipboard.writeText(code);
            btn.innerText = 'COPIADO';
            setTimeout(() => btn.innerText = 'COPIAR', 2000);
        }

        function openFullscreen(btn) {
            const code = btn.closest('.code-wrapper').querySelector('code').innerText;
            overlay.style.display = 'block';
            iframe.srcdoc = code;
        }

        function closeFullscreen() { overlay.style.display = 'none'; iframe.srcdoc = ''; }

        userInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());
    </script>
</body>
</html>
